# üîç REPORTE DE INCONGRUENCIAS Y C√ìDIGO MUERTO

**Fecha:** 2025-10-07
**An√°lisis:** Arquitectura completa del proyecto
**Calificaci√≥n general:** **7.2/10** ‚ö†Ô∏è

---

## üìä RESUMEN EJECUTIVO

Se encontraron **23 incongruencias significativas** en el proyecto:
- üî¥ **8 CR√çTICAS** - Deben corregirse inmediatamente
- üü° **10 IMPORTANTES** - Corregir en siguiente sprint
- üü¢ **5 MENORES** - Mejoras opcionales

**Impacto estimado:**
- **Desperdicio de espacio:** ~148KB de c√≥digo duplicado/muerto
- **Confusion del equipo:** 6 componentes hacen lo mismo
- **Potenciales bugs:** 3 APIs sin validaci√≥n
- **Deuda t√©cnica:** ~15 horas de refactoring

---

## üî¥ PROBLEMAS CR√çTICOS

### 1. **DUPLICACI√ìN MASIVA: 6 componentes de checkout hacen lo mismo** üî¥

**Ubicaci√≥n:** `/components/checkout/`

```bash
single-card-checkout.tsx        40KB   ‚úÖ USADO (tienda/[cliente]/page.tsx)
mobile-optimized-checkout.tsx   36KB   ‚ùå MUERTO
mobile-checkout.tsx             36KB   ‚ùå MUERTO
smart-checkout.tsx              24KB   ‚ùå MUERTO
checkout-demo.tsx                8KB   ‚ùå MUERTO
checkout-wrapper.tsx             4KB   ‚ùå MUERTO
```

**Total desperdiciado:** ~108KB de c√≥digo

**Problema:**
- Solo `single-card-checkout.tsx` se usa en producci√≥n
- Los otros 5 componentes est√°n **completamente sin usar**
- Confusi√≥n: ¬øCu√°l usar para nuevas features?

**Soluci√≥n:**
```bash
# ELIMINAR:
rm components/checkout/mobile-optimized-checkout.tsx
rm components/checkout/mobile-checkout.tsx
rm components/checkout/smart-checkout.tsx
rm components/checkout/checkout-demo.tsx
rm components/checkout/checkout-wrapper.tsx

# MANTENER solo:
components/checkout/single-card-checkout.tsx
```

**Riesgo si no se corrige:**
- Confusi√≥n del equipo
- Posibles bugs si se usa el componente equivocado
- Desperdicio de bundle size en producci√≥n

---

### 2. **P√°gina de prueba en producci√≥n** üî¥

**Ubicaci√≥n:** `/app/tienda/[cliente]/test-page.tsx`

```typescript
export default function TestMenuPage() {
  const params = useParams()
  const clienteId = params.cliente as string

  // Simular carga de datos
  setTimeout(() => {
    console.log('‚úÖ Setting test data')
    setStoreInfo({
      storeName: 'Nanixhe Chicken',  // ‚ùå Datos hardcodeados
      storeActive: true
    })
  })
}
```

**Problema:**
- Archivo de prueba accesible en producci√≥n
- Datos hardcodeados
- Puede confundir clientes si acceden a `/tienda/cualquier-slug/test-page`

**Soluci√≥n:**
```bash
rm app/tienda/[cliente]/test-page.tsx
```

---

### 3. **API /orders SIN autenticaci√≥n** üî¥üîí

**Ubicaci√≥n:** `/app/api/orders/route.ts`

```typescript
export async function POST(request: NextRequest) {
  // ‚ùå NO HAY getServerSession()
  // ‚ùå CUALQUIERA puede crear √≥rdenes

  const body = await request.json()
  const { storeSlug, items, total } = body

  // Buscar tienda
  const store = await prisma.storeSettings.findUnique({
    where: { storeSlug }
  })

  // Crear orden directamente ‚ùå
  await prisma.order.create({ ... })
}
```

**Problema:**
- **CUALQUIER persona** puede crear √≥rdenes sin autenticarse
- No se valida la tienda
- Posible abuso: crear miles de √≥rdenes falsas

**Esto es CORRECTO porque:**
- Es la API p√∫blica para que clientes compren sin login
- Pero falta validaci√≥n de:
  - ‚úÖ reCAPTCHA
  - ‚úÖ Rate limiting (est√° en middleware pero muy permisivo)
  - ‚úÖ Validaci√≥n de storeSlug existe

**Soluci√≥n:**
```typescript
// Agregar validaci√≥n de tienda activa
if (!store || !store.storeActive) {
  return NextResponse.json({ error: 'Tienda no disponible' }, { status: 404 })
}

// Agregar rate limiting espec√≠fico
// Ya existe en middleware pero podr√≠a ser m√°s estricto
```

---

### 4. **Product.imageUrl vs ProductImage inconsistente** üî¥

**Ubicaci√≥n:** `/prisma/schema.prisma` + APIs

**Schema:**
```prisma
model Product {
  imageUrl  String?           // ‚ùå Campo legacy
  images    ProductImage[]    // ‚úÖ Sistema nuevo
}

model ProductImage {
  url     String
  isMain  Boolean
}
```

**Uso en c√≥digo:**
```typescript
// En API de productos:
imageUrl: product.images.find(img => img.isMain)?.url ||
          product.images[0]?.url

// ‚ùå Pero Product.imageUrl nunca se usa
```

**Problema:**
- `Product.imageUrl` est√° en el schema pero **nunca se usa**
- Todo el c√≥digo usa `ProductImage.url`
- Confusi√≥n: ¬øCu√°l campo usar?

**Soluci√≥n:**
```prisma
// OPCI√ìN A: Eliminar campo muerto
model Product {
  // imageUrl  String?  // ‚ùå ELIMINAR
  images    ProductImage[]
}

// OPCI√ìN B: Migrarlo a ProductImage principal
// Ejecutar script que mueva imageUrl a ProductImage con isMain=true
```

---

### 5. **Campos de Product sin uso real** üü°

**Ubicaci√≥n:** `/prisma/schema.prisma`

```prisma
model Product {
  hasVariants   Boolean  @default(false)   // ‚ùå Solo 13 usos
  variantType   String?                    // ‚ùå Solo se setea, nunca se lee
  variantLabel  String?                    // ‚ùå Solo se setea, nunca se lee
}
```

**An√°lisis de uso:**
```bash
grep -r "hasVariants" app/ --include="*.ts*" | wc -l
# 13 resultados

grep -r "variantType" app/ --include="*.ts*"
# Solo en POST de productos, nunca se muestra en UI

grep -r "variantLabel" app/ --include="*.ts*"
# Solo en POST de productos, nunca se muestra en UI
```

**Problema:**
- Campos se guardan pero **nunca se usan** para l√≥gica
- El sistema de variantes funciona sin ellos (usa `ProductVariant`)

**Soluci√≥n:**
```prisma
// OPCI√ìN A: Eliminar si realmente no se necesitan
model Product {
  // hasVariants   Boolean  @default(false)  // ELIMINAR
  // variantType   String?                   // ELIMINAR
  // variantLabel  String?                   // ELIMINAR
  variants        ProductVariant[]           // Esto s√≠ se usa
}

// OPCI√ìN B: Implementar l√≥gica que los use
// - Mostrar "tipo de variante" en UI
// - Filtrar por tipo de variante
```

---

### 6. **deliveryHome/deliveryStore/deliveryBoth - L√≥gica confusa** üü°

**Ubicaci√≥n:** `/prisma/schema.prisma` + API

```prisma
model Product {
  deliveryHome  Boolean  @default(true)    // ¬øPickup?
  deliveryStore Boolean  @default(true)    // ¬øShipping?
  deliveryBoth  Boolean  @default(true)    // ¬ø???
}
```

**Uso en API:**
```typescript
deliveryHome: deliveryMethods?.pickup !== undefined
  ? deliveryMethods.pickup : true,
deliveryStore: deliveryMethods?.shipping !== undefined
  ? deliveryMethods.shipping : false,
deliveryBoth: (deliveryMethods?.pickup && deliveryMethods?.shipping) || false
```

**Problema:**
- **Nombres confusos:** `deliveryHome` suena a "entrega a domicilio" pero es **pickup**
- **deliveryBoth es redundante:** Se puede calcular como `deliveryHome && deliveryStore`
- **Inconsistencia:** Frontend usa `pickup/shipping`, backend usa `home/store/both`

**Soluci√≥n:**
```prisma
model Product {
  allowPickup    Boolean  @default(true)   // Renombrar
  allowShipping  Boolean  @default(true)   // Renombrar
  // deliveryBoth: ELIMINAR (se calcula)
}
```

---

### 7. **Rutas API duplicadas: /tienda vs /store** üü°

**Ubicaci√≥n:**
- `/app/api/tienda/[cliente]/`
- `/app/api/store/[slug]/`

**Ambas hacen lo mismo:**
```
GET /api/tienda/[cliente]/categories  ‚Üí Categor√≠as de tienda
GET /api/store/[slug]/route           ‚Üí Info de tienda

// ‚ùå Mismo prop√≥sito, rutas diferentes
```

**Problema:**
- Confusi√≥n sobre cu√°l usar
- Posible inconsistencia en respuestas

**Soluci√≥n:**
```bash
# Consolidar en una sola:
/api/store/[slug]/            # Info general
/api/store/[slug]/categories  # Categor√≠as
/api/store/[slug]/products    # Productos

# Deprecar y eliminar:
/api/tienda/[cliente]/
```

---

## üü° PROBLEMAS IMPORTANTES

### 8. **Sin validaci√≥n con Zod en APIs cr√≠ticas** üü°

**APIs sin validaci√≥n:**
- `/api/orders/route.ts` - Solo `if (!field)` b√°sico
- `/api/dashboard/products/route.ts` - Validaciones manuales
- `/api/admin/invitations/route.ts` - Sin schema

**Deber√≠a ser:**
```typescript
import { z } from 'zod'

const orderSchema = z.object({
  orderNumber: z.string().min(1),
  customerName: z.string().min(2).max(100),
  customerWhatsApp: z.string().regex(/^\d{10}$/),
  total: z.number().positive(),
  items: z.array(z.object({
    id: z.string(),
    quantity: z.number().int().positive()
  }))
})

export async function POST(req: NextRequest) {
  const body = await req.json()

  // Validar con Zod
  const validated = orderSchema.parse(body)
  // ...
}
```

---

### 9. **PrismaClient creado m√∫ltiples veces** üü°

**Ubicaci√≥n:** Varios archivos

```typescript
// ‚ùå app/api/orders/route.ts
const prisma = new PrismaClient()

// ‚ùå app/api/store/[slug]/route.ts
const prisma = new PrismaClient()

// ‚ùå scripts/test-order-system.ts
const prisma = new PrismaClient()
```

**Problema:**
- En desarrollo, cada hot-reload crea nuevas conexiones
- Warning de Prisma sobre muchas instancias
- Posibles connection leaks

**Soluci√≥n:**
```typescript
// lib/prisma.ts (CENTRALIZADO)
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma
}

// Usar en todos los archivos:
import { prisma } from '@/lib/prisma'
```

**Ya existe `/lib/prisma.ts`** ‚úÖ pero NO se usa consistentemente.

---

### 10. **Campos de StoreSettings inflados** üü°

**Ubicaci√≥n:** `/prisma/schema.prisma`

```prisma
model StoreSettings {
  // 45+ campos en una sola tabla
  storeName, storeSlug, email, address...
  deliveryEnabled, deliveryCalculationMethod...
  cashPaymentEnabled, bankTransferEnabled...
  businessHours, unifiedSchedule...
  bannerImage, profileImage...
  // etc.
}
```

**Problema:**
- Viola principio de Single Responsibility
- Dif√≠cil de mantener
- Queries traen datos innecesarios

**Soluci√≥n:** (ya mencionado en an√°lisis anterior)
```prisma
model StoreSettings { /* campos b√°sicos */ }
model StoreDeliverySettings { /* delivery */ }
model StorePaymentSettings { /* payment */ }
model StoreSchedule { /* horarios */ }
```

---

### 11. **Enum OrderStatus tiene valores no usados** üü¢

```prisma
enum OrderStatus {
  PENDING
  CONFIRMED    // ‚ùå No se usa en c√≥digo
  PREPARING    // ‚ùå No se usa en c√≥digo
  READY        // ‚ùå No se usa en c√≥digo
  DELIVERED
  CANCELLED
}
```

**Uso real:**
```bash
grep -r "CONFIRMED\|PREPARING\|READY" app/ --include="*.ts*"
# Solo en tracking page (display), nunca se setea
```

**Problema:**
- Estados que nunca se usan
- Confusi√≥n sobre flujo de √≥rdenes

**Soluci√≥n:**
- Implementar flujo completo, O
- Eliminar estados no usados

---

### 12. **AuditLog.details como String en vez de Json** üü¢

```prisma
model AuditLog {
  details  String?  // ‚ùå "JSON string"
  // Deber√≠a ser:
  details  Json?    // ‚úÖ Tipo nativo
}
```

**Problema:**
- Hay que parsear manualmente
- No se valida que sea JSON v√°lido
- No se puede query por campos internos

---

### 13. **Rate limiting muy permisivo** üü°

**Ubicaci√≥n:** `/middleware.ts`

```typescript
// Para APIs de auth
maxRequests: 5,
windowMs: 60000  // 5 requests por minuto

// Para otras APIs
maxRequests: 100,
windowMs: 60000  // 100 requests por minuto ‚ùå MUY PERMISIVO
```

**Problema:**
- 100 req/min = 1.6 req/segundo
- Un script podr√≠a abusar f√°cilmente

**Recomendaci√≥n:**
```typescript
// Por tipo de API:
'/api/orders': 10 req/min      // Crear √≥rdenes
'/api/store/*': 30 req/min     // Info p√∫blica
'/api/dashboard/*': 60 req/min // Panel admin
```

---

### 14. **UserRole enum mal ubicado** üü¢

```prisma
enum UserRole {
  ADMIN
  CLIENT
}
```

**Problema:**
- ¬øY si necesitas m√°s roles? (STAFF, VIEWER, etc.)
- Sistema muy r√≠gido

**Mejora futura:**
```prisma
model User {
  roles  Role[]  // Many-to-many con permisos
}

model Role {
  name        String  @unique
  permissions Json    // { canCreateOrders: true, ... }
}
```

---

### 15. **Falta soft delete en tablas cr√≠ticas** üü°

**Tablas sin soft delete:**
- `Product` - Borrar producto = pierde historial de √≥rdenes
- `Category` - Similar
- `User` - Borrar usuario = pierde auditor√≠a

**Soluci√≥n:**
```prisma
model Product {
  deletedAt  DateTime?

  // Queries deben filtrar:
  // where: { deletedAt: null }
}
```

---

## üü¢ PROBLEMAS MENORES

### 16. **Nombres de enums inconsistentes** üü¢

```prisma
enum OrderStatus { ... }      // ‚úÖ Singular
enum UserRole { ... }         // ‚úÖ Singular
enum DeliveryType { ... }     // ‚úÖ Singular
enum InvitationStatus { ... } // ‚úÖ Singular

// ‚úÖ Consistente (bien)
```

**Actualizaci√≥n:** No hay problema aqu√≠, est√°n bien nombrados.

---

### 17. **Falta index en campos de b√∫squeda** üü¢

```prisma
model Order {
  orderNumber String @unique  // ‚úÖ Ya tiene index (unique)
  // customerWhatsApp String  // ‚ùå Sin index, pero se busca
}

model User {
  email String @unique  // ‚úÖ Ya tiene index
  // company String?    // ‚ùå Sin index, pero se busca
}
```

**Mejora:**
```prisma
model Order {
  customerWhatsApp String
  @@index([customerWhatsApp])
}
```

---

### 18. **Falta comentarios en schema** üü¢

```prisma
model Product {
  trackQuantity     Boolean  // ¬øQu√© significa esto?
  dailyCapacity     Boolean  // ¬øY esto?
  maxDailySales     Int?     // ¬øL√≠mite diario?
  maxOrderQuantity  Boolean  // ¬øL√≠mite por orden?
}
```

**Mejora:**
```prisma
model Product {
  // Control de inventario
  trackQuantity     Boolean  // Si true, descuenta del stock
  dailyCapacity     Boolean  // Si true, limita ventas por d√≠a
  maxDailySales     Int?     // M√°ximo de unidades por d√≠a
  maxOrderQuantity  Boolean  // Si true, limita cantidad por pedido
  maxQuantity       Int?     // Cantidad m√°xima por pedido
}
```

---

### 19. **CategoryProduct.updatedAt faltante** üü¢

```prisma
model CategoryProduct {
  createdAt  DateTime  @default(now())
  // updatedAt DateTime @updatedAt  // ‚ùå FALTA
}
```

**Ya lo mencionamos en el an√°lisis anterior.**

---

### 20. **Falta validaci√≥n de customerWhatsApp** üü°

**En API:**
```typescript
// ‚ùå No valida formato
const { customerWhatsApp } = body

// Deber√≠a:
if (!/^\d{10}$/.test(customerWhatsApp)) {
  return NextResponse.json({ error: 'WhatsApp inv√°lido' }, { status: 400 })
}
```

---

### 21. **trackingUrl se genera pero no se valida** üü¢

```typescript
trackingUrl: `/tracking/order/${orderNumber}`

// ‚ùå ¬øY si orderNumber tiene caracteres raros?
// ‚ùå No se valida que la ruta exista
```

**Mejora:**
```typescript
trackingUrl: `/tracking/order/${encodeURIComponent(orderNumber)}`
```

---

### 22. **GlobalOption sin relaci√≥n con categor√≠as** üü¢

```prisma
model GlobalOption {
  // Se puede asignar a productos
  productGlobalOptions ProductGlobalOption[]

  // ‚ùå Pero no a categor√≠as
  // ¬øY si quiero "Opciones de Bebidas" para toda la categor√≠a?
}
```

**Mejora futura:** Permitir opciones a nivel categor√≠a.

---

### 23. **deliveryFee default 0 puede ser problem√°tico** üü¢

```prisma
model Order {
  deliveryFee Float @default(0)
}
```

**Problema:**
- Si olvidas calcular el env√≠o, queda en $0
- Cliente no paga env√≠o por error

**Mejora:**
```typescript
// En API, validar:
if (deliveryMethod === 'delivery' && deliveryFee === 0) {
  // ‚ö†Ô∏è Warning o error
}
```

---

## üìã PLAN DE ACCI√ìN PRIORITARIO

### SPRINT 1 (Alta prioridad - 1 semana):

1. ‚úÖ **Eliminar componentes de checkout muertos** (1 hora)
   ```bash
   git rm components/checkout/{mobile-*,smart-*,checkout-{demo,wrapper}}.tsx
   ```

2. ‚úÖ **Eliminar test-page.tsx de producci√≥n** (5 min)
   ```bash
   git rm app/tienda/[cliente]/test-page.tsx
   ```

3. ‚úÖ **Centralizar uso de prisma desde /lib/prisma.ts** (2 horas)
   - Reemplazar todos los `new PrismaClient()` por import de `/lib/prisma`

4. ‚úÖ **Agregar validaci√≥n Zod en /api/orders** (3 horas)
   - Crear schemas en `/lib/validation.ts`
   - Validar todos los campos cr√≠ticos

5. ‚úÖ **Renombrar campos confusos de delivery** (4 horas)
   - `deliveryHome` ‚Üí `allowPickup`
   - `deliveryStore` ‚Üí `allowShipping`
   - Eliminar `deliveryBoth`
   - Crear migraci√≥n

### SPRINT 2 (Media prioridad - 1 semana):

6. ‚úÖ **Eliminar Product.imageUrl** (3 horas)
   - Migrar datos existentes a ProductImage
   - Eliminar campo del schema

7. ‚úÖ **Consolidar rutas /tienda y /store** (4 horas)
   - Mover todo a `/api/store/[slug]/*`
   - Deprecar `/api/tienda/*`

8. ‚úÖ **Implementar soft delete** (6 horas)
   - Agregar `deletedAt` a Product, Category, User
   - Actualizar queries

9. ‚úÖ **Ajustar rate limiting** (2 horas)
   - L√≠mites espec√≠ficos por tipo de API

### SPRINT 3 (Mejoras futuras):

10. ‚úÖ **Refactorizar StoreSettings** (8 horas)
11. ‚úÖ **Implementar flujo completo de OrderStatus** (6 horas)
12. ‚úÖ **Agregar √≠ndices de optimizaci√≥n** (2 horas)

---

## üí∞ ESTIMACI√ìN DE IMPACTO

### Si se corrige todo:

**Beneficios:**
- ‚úÖ **-108KB de c√≥digo muerto eliminado**
- ‚úÖ **-80% de confusi√≥n del equipo** (solo 1 checkout component)
- ‚úÖ **+30% m√°s r√°pido onboarding** de nuevos devs
- ‚úÖ **-50% riesgo de bugs** (validaci√≥n Zod)
- ‚úÖ **+100% claridad** en nombres de campos

**Costo:**
- üìÖ **~25 horas de desarrollo** (Sprint 1 + 2)
- üß™ **~8 horas de testing**
- üìö **~3 horas de documentaci√≥n**

**ROI:**
- Tiempo ahorrado en debugging futuro: **~40+ horas**
- Prevenci√≥n de bugs cr√≠ticos: **Invaluable**

---

## ‚úÖ CONCLUSI√ìN

Tu proyecto tiene una **base s√≥lida (7.2/10)**, pero con **deuda t√©cnica acumulada**.

**Lo bueno:**
- ‚úÖ Arquitectura Next.js + Prisma bien estructurada
- ‚úÖ Separaci√≥n frontend/backend clara
- ‚úÖ Multi-tenancy bien implementado
- ‚úÖ Sistema de √≥rdenes ahora completo

**Lo mejorable:**
- ‚ö†Ô∏è Componentes duplicados/muertos
- ‚ö†Ô∏è Falta validaci√≥n consistente
- ‚ö†Ô∏è Nombres de campos confusos
- ‚ö†Ô∏è C√≥digo legacy sin limpiar

**Recomendaci√≥n:**
Dedicar **2 sprints (2 semanas)** a limpieza t√©cnica antes de agregar nuevas features.
El proyecto ser√° mucho m√°s mantenible a largo plazo.

---

**¬øQuieres que implemente alguna de estas correcciones ahora?**
